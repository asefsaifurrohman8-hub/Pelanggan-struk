<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEAR LOVE - Struk Pelanggan</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #103d81; --paper: #fffdf0; --ink: #2d2d2d; }
        
        body { 
            margin: 0; background: var(--primary); font-family: 'Poppins', sans-serif; 
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .app-container { width: 100%; max-width: 380px; text-align: center; }

        /* LOADING & EMPTY STATE */
        #loading { color: white; animation: pulse 1.5s infinite; }
        .empty-box { color: white; margin-top: 20px; }
        .logo-box { width: 100px; padding: 15px; background: white; border-radius: 15px; margin: 0 auto 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .logo-box img { width: 100%; display: block; }

        /* --- DESAIN STRUK --- */
        .receipt-card {
            background: var(--paper); 
            width: 100%;
            padding: 40px 25px 50px 25px; /* Padding bawah extra untuk sobekan */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; /* Hidden by default */
            position: relative;
            color: var(--ink);
            font-family: 'Share Tech Mono', monospace; /* Font struk printer */
            text-align: center;
            box-sizing: border-box;
            
            /* Efek Kertas Sobek (Zigzag) */
            clip-path: polygon(
                0% 0%, 100% 0%, 100% 100%, 
                95% 98%, 90% 100%, 85% 98%, 80% 100%, 75% 98%, 70% 100%, 65% 98%, 
                60% 100%, 55% 98%, 50% 100%, 45% 98%, 40% 100%, 35% 98%, 30% 100%, 
                25% 98%, 20% 100%, 15% 98%, 10% 100%, 5% 98%, 0% 100%
            );
            overflow: hidden; 
        }

        /* WATERMARK */
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 40px; font-weight: 800; color: rgba(16, 61, 129, 0.08);
            pointer-events: none; white-space: nowrap; z-index: 0;
            border: 4px solid rgba(16, 61, 129, 0.08); padding: 10px 30px; border-radius: 10px;
        }

        /* HEADER TOKO (BISA DIEDIT) */
        .shop-header { position: relative; z-index: 1; margin-bottom: 20px; border-bottom: 2px dashed #ccc; padding-bottom: 15px; }
        .shop-name { font-size: 22px; font-weight: 700; margin: 0; text-transform: uppercase; outline: none; }
        .shop-address { font-size: 12px; margin-top: 5px; outline: none; line-height: 1.4; }
        
        /* ISI STRUK */
        .trx-info { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 15px; position: relative; z-index: 1; }
        
        .item-list { width: 100%; font-size: 14px; margin-bottom: 20px; position: relative; z-index: 1; text-align: left; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        .item-sub { font-size: 11px; color: #555; margin-bottom: 8px; }

        .total-box { 
            border-top: 2px dashed #ccc; border-bottom: 2px dashed #ccc; 
            padding: 15px 0; margin-bottom: 25px; position: relative; z-index: 1; 
        }
        .total-row { display: flex; justify-content: space-between; font-size: 22px; font-weight: 700; }

        .footer-msg { font-size: 12px; margin-top: 20px; position: relative; z-index: 1; line-height: 1.6; }

        /* TOMBOL DOWNLOAD */
        .action-area { margin-top: 30px; position: relative; z-index: 10; }
        .btn-download {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            background: var(--primary); color: white; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-family: 'Poppins', sans-serif; font-size: 14px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .btn-download:active { transform: scale(0.96); }
        
        .edit-hint { font-size: 10px; color: #999; margin-top: 5px; font-family: sans-serif; display: block; font-style: italic;}

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="loading">
            <span class="material-icons-round" style="font-size: 48px;">hourglass_empty</span>
            <p style="margin-top: 10px; font-size: 12px;">Menghubungkan Server...</p>
        </div>

        <div id="receiptUI" class="receipt-card">
            
            <div class="watermark">DEAR LOVE</div>

            <div class="shop-header">
                <div class="shop-name" contenteditable="true" id="editShopName">POM MINI</div>
                <div class="shop-address" contenteditable="true" id="editAddress">Jl.Kp.curug,Cibarusah kota,
                    Cibarusah, Bekasi</div>
                <span class="edit-hint"></span>
            </div>

            <div class="trx-info">
                <span id="txtWaktu">--/--/-- --:--</span>
                <span>CASH</span>
            </div>

            <div class="item-list">
                <div class="item-row">
                    <span>PERTALITE</span>
                    <span id="txtTotalTop">0</span>
                </div>
                <div class="item-sub" id="txtLiter">0,00 L x 10.000</div>
            </div>

            <div class="total-box">
                <div class="total-row">
                    <span>TOTAL</span>
                    <span id="txtTotalBig">Rp 0</span>
                </div>
            </div>

            <div class="footer-msg">
                TERIMA KASIH<br>SELAMAT JALAN
            </div>

            <div class="action-area">
                <button class="btn-download" onclick="downloadStruk()">
                    <span class="material-icons-round">save_alt</span> Simpan Gambar
                </button>
            </div>
        </div>

        <div id="emptyState" class="empty-box" style="display:none;">
            <div class="logo-box">
                <img src="logo.png" alt="DEAR LOVE" onerror="this.style.display='none'">
            </div>
            <h3 style="margin:0;">DEAR LOVE</h3>
            <p style="font-size: 12px; opacity: 0.8;">Menunggu transaksi dari admin...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyBpwNPIYhelOhkPvJsBmKvlZnaH9FVnmM4",
            authDomain: "pom-mini-50b1e.firebaseapp.com",
            databaseURL: "https://pom-mini-50b1e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pom-mini-50b1e",
            storageBucket: "pom-mini-50b1e.firebasestorage.app",
            messagingSenderId: "77499696502",
            appId: "1:77499696502:web:8080c37da62a12c9566657",
            measurementId: "G-KRRHTTGBRF"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Listener Realtime
        onSnapshot(doc(db, "struk_public", "current"), (doc) => {
            document.getElementById('loading').style.display = 'none';
            
            if (doc.exists()) {
                const data = doc.data();
                renderStruk(data);
            } else {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('receiptUI').style.display = 'none';
            }
        });

        // Fungsi Update Tampilan
        function renderStruk(data) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('receiptUI').style.display = 'block';
            
            // Format Rupiah
            const formattedTotal = parseInt(data.nominal).toLocaleString("id-ID");
            
            // Update Data Transaksi
            document.getElementById('txtTotalBig').innerText = "Rp " + formattedTotal;
            document.getElementById('txtTotalTop').innerText = formattedTotal;
            document.getElementById('txtLiter').innerText = `${data.liter} L x 10.000`;
            document.getElementById('txtWaktu').innerText = data.waktu;

            // UPDATE DATA TOKO (Jika Admin mengirim perubahan)
            // Cek apakah di database ada field 'nama_toko'
            if(data.nama_toko && data.nama_toko.trim() !== "") {
                document.getElementById('editShopName').innerText = data.nama_toko;
            }
            
            // Cek apakah di database ada field 'alamat_toko'
            if(data.alamat_toko && data.alamat_toko.trim() !== "") {
                document.getElementById('editAddress').innerText = data.alamat_toko;
            }
        }

        // FUNGSI DOWNLOAD (SCREENSHOT DOM)
        window.downloadStruk = function() {
            const receiptElement = document.getElementById('receiptUI');
            const downloadBtn = document.querySelector('.action-area');
            const hints = document.querySelectorAll('.edit-hint');
            
            // 1. Sembunyikan elemen yang tidak perlu difoto (Tombol & Petunjuk Edit)
            downloadBtn.style.display = 'none';
            hints.forEach(el => el.style.display = 'none');

            // 2. Ambil Screenshot elemen Struk
            html2canvas(receiptElement, {
                scale: 3, // Skala tinggi biar HD (tidak pecah)
                backgroundColor: null, // Background transparan di luar kertas
                useCORS: true // Izinkan gambar eksternal
            }).then(canvas => {
                // 3. Proses Download
                const link = document.createElement('a');
                link.download = `Struk-DearLove-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                // 4. Munculkan kembali tombol
                downloadBtn.style.display = 'block';
                hints.forEach(el => el.style.display = 'block');
            }).catch(err => {
                console.error("Gagal membuat gambar:", err);
                alert("Gagal menyimpan gambar. Silakan coba lagi.");
                downloadBtn.style.display = 'block';
                hints.forEach(el => el.style.display = 'block');
            });
        }
    </script>
</body>
</html>
